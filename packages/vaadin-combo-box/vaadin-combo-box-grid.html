<!--
@element vaadin-combo-box-grid
-->

<link rel='import' href='../polymer/polymer.html'>
<link rel='import' href='../vaadin-grid/vaadin-grid.html'>

<dom-module id="vaadin-combo-box-grid">
  <template>
    <style>
      :host::content .v-grid-cell.v-grid.selected {
        background: #ddd;
      }
    </style>
    <vaadin-grid id="grid">
      <table>
        <col>
          <thead hidden>
            <tr></tr>
          </thead>
      </table>
    </vaadin-grid>
  </template>
</dom-module>

<script>
  Polymer({

    is: "vaadin-combo-box-grid",

    properties: {
      selectedItem: {
        notify: true
      },
      filter: {
        type: String,
        observer: "filterChanged"
      }

    },

    behaviors: [Polymer.Templatizer],

    listeners: {
      "grid.select": "onSelection"
    },

    ready: function() {
      this.template = Polymer.dom(this).querySelector('template');
      this.templatize(this.template);

      if (this.template) {
        this.$.grid.columns[0].renderer = this.renderer.bind(this);
      }

      this.$.grid.data.source = function(req) {
        req.filter = this.filter;
        this.dataSource(req);
      }.bind(this);
    },

    renderer: function(cell) {
      var instance = this.stamp();
      instance.item = cell.data;
      cell.element.innerHTML = "";
      Polymer.dom(cell.element).appendChild(instance.root);
      //TODO: Also needed for non-templated renderer
      this.toggleClass('selected', cell.data == this.selectedItem, cell.element);
    },

    filterChanged: function() {
      this.$.grid.data.clearCache();
    },

    onSelection: function() {
      var selectedIndex = this.$.grid.selection.selected()[0];

      if (selectedIndex !== undefined) {
        this.$.grid.selection.deselect(selectedIndex);
        this.$.grid.data.getItem(selectedIndex, function(err, item) {

          this.$.grid.then(function() {
            this.selectedItem = item;
            this.fire("selected");
          }.bind(this));

        }.bind(this));
      }
    },

  }); // End Polymer prototype
</script>
