<!--
@element vaadin-combo-box-grid
-->

<link rel='import' href='../polymer/polymer.html'>
<link rel='import' href='../vaadin-grid/vaadin-grid.html'>

<dom-module id="vaadin-combo-box-grid">
  <template>
    <style>
      :host::content .v-grid-cell.v-grid.selected {
        background: #ddd;
      }
    </style>

    <vaadin-grid id="grid">
      <table>
        <col>
      </table>
    </vaadin-grid>
  </template>
</dom-module>

<script>
  Polymer({

    is: "vaadin-combo-box-grid",

    properties: {
      selectedItem: {
        notify: true
      },
      filter: {
        type: String,
        observer: "filterChanged"
      },
      dataSource: {
        observer: "_dataSourceChanged"
      },
      cellTemplates: {
        observer: "_cellTemplatesChanged"
      }


    },

    behaviors: [Polymer.Templatizer],

    listeners: {
      "grid.select": "onSelection"
    },

    ready: function() {
      this.$.grid.header.hidden = true;
    },

    _filterDataSource: function(req) {
      if (Array.isArray(this.dataSource)){
        var filtered = this.dataSource.filter(function(item) {
          return item.toString().toLowerCase().indexOf(this.filter.toLowerCase()) != -1;
        }.bind(this));
        var array = filtered.slice(req.index, req.index + req.count);
        req.success(array, filtered.length);
      } else {
        req.filter = this.filter;
        if (req.filter === undefined){
          req.filter = "";
        }
        this.dataSource(req);
      }
    },

    _dataSourceChanged: function() {
      this.$.grid.data.source = this._filterDataSource.bind(this);
    },

    _cellTemplatesChanged: function(templates) {
      if (templates.length > 0) {
        this.$.grid.columns = templates.map(function(template, index) {
          return {
            renderer: this.templateRenderer.bind(this),
            template: template,
            name: "column" + index
          };
        }.bind(this));
      }
    },

    templateRenderer: function(cell) {
      // TODO: Templatizing this on every render might be heavy. Any other options?
      this.templatize(this.$.grid.columns[cell.index].template);
      var instance = this.stamp();
      instance.item = cell.row.data;
      cell.element.innerHTML = "";
      Polymer.dom(cell.element).appendChild(instance.root);
      //TODO: Also needed for non-templated renderer
      this.toggleClass('selected', cell.data == this.selectedItem, cell.element);
    },

    filterChanged: function() {
      if (this.$.grid.data.source) {
        var size = this.filter === "" ? 1000 : undefined;
        this.$.grid.data.clearCache(size);
      }
    },

    onSelection: function() {
      var selectedIndex = this.$.grid.selection.selected()[0];

      if (selectedIndex !== undefined) {
        this.$.grid.selection.deselect(selectedIndex);
        this.$.grid.data.getItem(selectedIndex, function(err, item) {

          this.$.grid.then(function() {
            this.selectedItem = item;
            this.fire("selected");
          }.bind(this));

        }.bind(this));
      }
    },

  }); // End Polymer prototype
</script>
