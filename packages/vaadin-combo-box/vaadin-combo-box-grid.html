<!--
@element vaadin-combo-box-grid
-->

<link rel='import' href='../polymer/polymer.html'>
<link rel='import' href='../vaadin-components/vaadin-grid/vaadin-grid.html'>

<dom-module id="vaadin-combo-box-grid">
  <template>
    <style>
      :host ::content .v-grid-cell.v-grid.selected {
        background: #ddd;
      }
    </style>
    <v-grid id="grid">
      <table>
        <col>
        <thead hidden>
          <tr></tr>
        </thead>
      </table>
    </v-grid>
    <div id="templateWrapper" style="display: none">
      <content>
    </div>
  </template>
</dom-module>

<script>
  Polymer({

    is: "vaadin-combo-box-grid",

    properties: {
      selectedItem: {
        notify: true
      },
      filter: {
        type: String,
        observer: "filterChanged"
      }

    },

    listeners: {
      "grid.select" : "onSelection"
    },

    ready() {
       this.template = this.$.templateWrapper.querySelector("template");
       if (this.template) {
         this.$.grid.columns[0].renderer = this.renderer.bind(this);
       }

       this.$.grid.data.source = function(req) {
         req.filter = this.filter;
         this.dataSource(req);
       }.bind(this);
     },

     renderer(cell) {
       this.template.item = cell.data;
       cell.element.innerHTML = this.$.templateWrapper.innerHTML;
       //TODO: Also needed for non-templated renderer
       this.toggleClass('selected', cell.data == this.selectedItem, cell.element);
     },

     filterChanged() {
       this.$.grid.data.clearCache();
     },

     onSelection() {
       var selectedIndex = this.$.grid.selection.selected()[0];

       if (selectedIndex !== undefined) {
         this.$.grid.selection.deselect(selectedIndex);
         this.$.grid.data.getItem(selectedIndex, function(err, item) {
           this.selectedItem = item;
           this.fire("selected");
         }.bind(this));
       }
     },

  }); // End Polymer prototype
</script>
