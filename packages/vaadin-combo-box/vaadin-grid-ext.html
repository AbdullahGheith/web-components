<!--
This is a temporary component providing some still missing api on top of basic vaadin-grid.
-->

<link rel='import' href='../polymer/polymer.html'>
<link rel='import' href='../vaadin-grid/vaadin-grid.html'>

<dom-module id="vaadin-grid-ext">
  <template>
    <style>
      ::content vaadin-grid tbody tr.selected td.vaadin-grid {
        background-color: #ddd;
      }


      ::content vaadin-grid tbody .vaadin-grid-row:after {
        display: none !important;
      }
      ::content vaadin-grid tbody tr.selection-disabled td {
        cursor: default;
      }
      ::content vaadin-grid tbody tr.selection-disabled td.vaadin-grid * {
        opacity: 0.5 !important;
      }
    </style>
    <vaadin-grid id="grid" on-select="_onSelect">
      <table>
        <col>
        <thead hidden><tr></tr></thead>
      </table>
    </vaadin-grid>
    <content id="templates">
  </template>
</dom-module>

<script>
  Polymer({

    is: "vaadin-grid-ext",

    properties: {
      selectedItem: {
        notify: true,
        // Need to make the grid re-render somehow on select
        observer: "_bindRowClassGenerator"
      },
      filter: {
        type: String,
        value: "",
        observer: "_filterChanged"
      },
      items: {
        observer: "_itemsChanged"
      }

    },

    behaviors: [Polymer.Templatizer],

    ready: function() {
      this._updateCellTemplates();
      this._bindRowClassGenerator();
    },

    _rowClassGenerator: function(row) {
      // There seems to be a bug in row.data so need to use getItem api here for now
      var element = row.element;
      this.$.grid.data.getItem(row.index, function(e, i) {
        this.toggleClass("selected", i === this.selectedItem, element);
        this.toggleClass("selection-disabled", i.selectionDisabled, element);
      }.bind(this));
    },

    _filterDataSource: function(req) {
      if (Array.isArray(this.items)) {
        var filtered = this.items.filter(function(item) {
          return item.toString().toLowerCase().indexOf(this.filter.toLowerCase()) != -1;
        }.bind(this));
        var array = filtered.slice(req.index, req.index + req.count);
        req.success(array, filtered.length);
      } else {
        req.filter = this.filter;
        if (req.filter === undefined){
          req.filter = "";
        }
        this.items(req);
      }
    },

    _itemsChanged: function() {
      this.$.grid.data.source = this._filterDataSource.bind(this);
    },

    _bindRowClassGenerator: function(){
      this.$.grid.rowClassGenerator = this._rowClassGenerator.bind(this);
    },

    _updateCellTemplates: function(templates) {
      var templates = Polymer.dom(this.$.templates).getDistributedNodes().filter(
        function (node) {return node.tagName === "TEMPLATE"}
      )
      if (templates.length > 0) {
        this.$.grid.columns = templates.map(function(template, index) {
          return {
            renderer: this._templateRenderer.bind(this),
            template: template,
            name: "column" + index
          };
        }.bind(this));
      }
    },

    _templateRenderer: function(cell) {
      // TODO: Templatizing this on every render might be heavy. Any other options?
      this.templatize(this.$.grid.columns[cell.index].template);
      var instance = this.stamp();
      instance.item = cell.row.data;
      cell.element.innerHTML = "";
      Polymer.dom(cell.element).appendChild(instance.root);
    },

    _filterChanged: function() {
      if (this.$.grid.data.source) {
        var size = this.filter === "" ? 1000 : undefined;
        this.$.grid.data.clearCache(size);
      }
    },

    _onSelect: function() {
      var selectedIndex = this.$.grid.selection.selected()[0];

      if (selectedIndex !== undefined) {
        this.$.grid.selection.deselect(selectedIndex);
        this.$.grid.data.getItem(selectedIndex, function(err, item) {

          this.$.grid.then(function() {
            if (!item.selectionDisabled) {
              this.selectedItem = item;
              this.fire("select");
            }
          }.bind(this));

        }.bind(this));
      }
    },

  }); // End Polymer prototype
</script>
