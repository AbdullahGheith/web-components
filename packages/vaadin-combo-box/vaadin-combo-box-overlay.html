<!--
@element vaadin-combo-box-overlay
-->

<link rel='import' href='../polymer/polymer.html'>
<link rel='import' href='../iron-input/iron-input.html'>
<link rel='import' href='vaadin-grid-ext.html'>
<link rel='import' href='../iron-dropdown/iron-dropdown.html'>
<link rel='import' href='../paper-input/paper-input-container.html'>

<dom-module id="vaadin-combo-box-overlay">
  <template>
    <style>
      :host {
        @apply(--layout-vertical);
        width: 100%;
        position: absolute;
        bottom: 0;
        left: 0;
      }

      :host[mobile] iron-dropdown {
        top: 0 !important;
        left: 0 !important;
        width: 100%;
      }

      :host[mobile] iron-dropdown,
      :host[mobile]::content #contentWrapper,
      :host[mobile] .dropdown-content,
      :host[mobile] vaadin-grid-ext,
      :host[mobile]::content vaadin-grid {
        height: 100%;
      }

      :host[mobile] vaadin-grid-ext {
        padding-bottom: 60px;
        box-sizing: border-box;
      }

      :host:not([mobile]) paper-input-container {
        display: none;
      }

      paper-input-container {
        background-color: #fff;
      }

      #filterinput {
        width: 100%;
      }

      :host:not([mobile]) .dropdown-content {
        width: 10000px;
      }

      :host[mobile] .dropdown-content {
        max-width: 100%;
        @apply(--layout-vertical);
      }

      :host::content .v-grid-cell.v-grid.selected {
        background: #ddd;
      }

      #dropdown:not([aria-hidden]) .dropdown-content {
        overflow: hidden;
      }
    </style>
    <iron-dropdown id="dropdown" on-iron-overlay-closed="_closed" opened={{opened}} focus-target=[[input]] fit-into="[[fitInto]]" vertical-align="top" with-backdrop=[[mobile]]>
      <div class="dropdown-content">

        <paper-input-container id="inputcontainer" always-float-label>
          <label>[[label]]</label>
          <input id="filterinput" on-keyup="filterItems" is="iron-input" bind-value="[[filter]]">
          <iron-icon on-click="clear" suffix icon="clear"></iron-icon>
        </paper-input-container>

        <vaadin-grid-ext id="grid" on-select="close" items=[[items]] selected-item="{{selected}}" filter=[[filter]]>
          <content>
        </vaadin-grid-ext>
      </div>
    </iron-dropdown>
  </template>
</dom-module>

<script>
  Polymer({

    is: "vaadin-combo-box-overlay",

    filterItems: function() {
      this.filter = this.$.filterinput.value;
    },

    clear: function() {
      if (this.$.filterinput.value) {
        this.filter = "";
        this.$.filterinput.value = "";
        this.$.filterinput.focus();
      } else {
        this.close();
      }
    },

    _viewport: function() {
      var viewport = document.querySelector('meta[name="viewport"]');
      if (!viewport) {
        viewport = document.createElement("meta");
        viewport.setAttribute("name", "viewport");
        document.querySelector('head').appendChild(viewport);
      }
      viewport._originalContent = viewport.content;
      return viewport;
    }(),

    changeViewPort: function(key, val) {
      var reg = new RegExp(key, "i"),
        oldval = this._viewport.content;
      var newval = reg.test(oldval) ? oldval.split(/,\s*/).map(function(v) {
        return reg.test(v) ? key + "=" + val : v;
      }).join(", ") : oldval += ", " + key + "=" + val;
      this._viewport.content = newval;
    },

    ready: function() {
      this.$.dropdown.focusTarget = this.$.filterinput;

      // Disable scrolling the body while dropdown open (iOS)
      this.addEventListener("touchmove", function(e) {
        e.preventDefault();
      });
      // On iOs we'll need to handle available viewport height (while virtual keyboard open) somehow else
      if (this._isIOS) {
        // Temporary
        this.$.grid.$.grid.style.maxHeight = "170px";
      }
    },

    open: function() {
      this.filter = "";
      this.$.dropdown.open();

      if (this.mobile) {
        // Alter viewport
        this.changeViewPort("maximum-scale", "1");
        this.changeViewPort("width", "device-width");

        if (this._isIOS) {
          // Cache scrollTop
          this._scrollTop = document.body.scrollTop;
          document.body.scrollTop = 0;
        }
      }

    },

    close: function() {
      this.$.dropdown.close();
    },

    _closed: function() {
      this.fire("iron-overlay-closed");

      if (this.mobile) {
        // Restore original viewport content
        this._viewport.content = this._viewport._originalContent;

        if (this._isIOS) {
          // Restore scrollTop
          document.body.scrollTop = this._scrollTop;
        }
      }
    },

    properties: {
      selected: {
        notify: true
      },
      mobile: {
        reflectToAttribute: true
      },
      _useDefaultSelector: {
        value: false
      },
      _isIOS: {
        value: /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream
      }

    }


  });
</script>
