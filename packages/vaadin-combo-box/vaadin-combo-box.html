<!--
@element vaadin-combo-box
-->

<link rel='import' href='../polymer/polymer.html'>
<link rel='import' href='../paper-input/paper-input-container.html'>
<link rel='import' href='../iron-input/iron-input.html'>
<link rel='import' href='../iron-icons/iron-icons.html'>
<link rel='import' href='../iron-icon/iron-icon.html'>
<link rel='import' href='../iron-form-element-behavior/iron-form-element-behavior.html'>
<link rel='import' href='../iron-validatable-behavior/iron-validatable-behavior.html'>
<link rel="import" href="../iron-list/iron-list.html">
<link rel="import" href="../iron-a11y-keys-behavior/iron-a11y-keys-behavior.html">
<link rel='import' href='vaadin-adaptive-overlay.html'>

<dom-module id='vaadin-combo-box'>
  <style>
    /* Temporary styles */

    #selector {
      background: #fff;
    }

    .item {
      cursor: pointer;
      padding: 16px 22px;
      border-bottom: 1px solid #ddd;
      background-color: #fff;
    }

    .item:hover {
      background: #eee;
    }

    .item[selected] {
      background-color: var(--google-grey-100);
    }

    .item[focused] {
      background-color: #ddd !important;
    }

    #overlay paper-input-container {
      background-color: #fff;
    }

    #overlay:not([full-screen]) paper-input-container {
      display: none;
    }


  </style>

  <template>
    <paper-input-container on-tap='open' on-touchend='_preventDefault'>
      <input id='input' autocomplete='off' is='iron-input' bind-value='[[value]]' name$='[[name]]' type='text' required$="[[required]]" on-bind-value-changed='_inputValueChanged' key-event-target>
      <iron-icon icon='arrow-drop-down' suffix></iron-icon>
    </paper-input-container>

    <vaadin-adaptive-overlay id='overlay' opened={{opened}}>
      <paper-input-container>
        <input id='fullScreenInput' autocomplete='off' is='iron-input' bind-value='[[value]]' on-bind-value-changed='_fullScreenInputValueChanged'>
        <iron-icon icon='arrow-drop-down' on-tap='close' suffix></iron-icon>
      </paper-input-container>
      <iron-list id='selector' items='[[items]]' selected-item='[[value]]' on-selected-item-changed='_selectedItemChanged' selection-enabled>
        <template>
          <div class='item' selected$=[[selected]] focused$=[[_isItemFocused(_focusedIndex,index)]]>[[item]]</div>
        </template>
      </iron-list>
    </vaadin-adaptive-overlay>
  </template>
</dom-module>

<script>
  Polymer({
    is: 'vaadin-combo-box',

    behaviors: [
      Polymer.IronFormElementBehavior,
      Polymer.IronValidatableBehavior,
      Polymer.IronA11yKeysBehavior
    ],

    properties: {
      /**
       * True if the dropdown is open, false otherwise.
       */
      opened: {
        type: Boolean,
        notify: true,
        value: false,
        observer: '_openedChanged'
      },
      /**
       * The value for this element.
       */
      value: {
        type: String,
        observer: 'close'
      },

      _focusedIndex: {
        type: Number,
        value: -1
      }
    },

    keyBindings: {
      'down': '_onArrowDown',
      'up': '_onArrowUp',
      'enter': '_onEnter',
      'esc' : '_onEscape'
    },

    ready: function() {

      //iron-dropdown prevents all scrolling related keypresses (such as up,down,left,right)
      //from elements that are outside the overlay. We need to allow keypresses that are
      //targeted to our input field.
      var isScrollingKeypress = Polymer.IronDropdownScrollManager._isScrollingKeypress.bind(this.$.dropdown);
      Polymer.IronDropdownScrollManager._isScrollingKeypress = function(event) {
        if(event.target === this.$.input) {
          return false;
        }

        return isScrollingKeypress(event);
      }.bind(this);
    },

    /**
     * Open the overlay.
     */
    open: function() {
      this.$.overlay.open();
    },

    _onArrowDown: function() {
      if(this.opened) {
        if(this._focusedIndex < this.$.selector.items.length - 1) {
          this._focusedIndex += 1;
        }
      } else {
        this.open();
      }
    },

    _onArrowUp: function() {
      if(this.opened) {
        if(this._focusedIndex > 0) {
          this._focusedIndex -= 1;
        }
      } else {
        this.open();
      }
    },

    _onEnter: function() {
      if(this.opened) {
        if(this._focusedIndex > -1) {
          this.close();
          this.$.selector.selectItem(this._focusedIndex);
        } else if(this.$.input.bindValue === undefined || this.$.input.bindValue === '') {
          this.close();
          this.value = undefined;
        }
      }
    },

    _onEscape: function() {
      this.close();
    },

    _isItemFocused: function(focusedIndex, itemIndex) {
      return (focusedIndex === itemIndex);
    },

    _fullScreenInputValueChanged: function(event) {
      this.$.input.bindValue = event.detail.value;
    },

    _inputValueChanged: function() {
      if(!this.opened && this._isFiltering()) {
          this.open();
      }

      if(this.opened && this.items) {
        this._setItems(this._filter(this.items, this.$.input.bindValue));
      }
    },

    _setItems: function(items) {
      this.$.selector.items = items;

      if (this.$.selector.items && this.$.selector.items.indexOf(this.value) > -1) {
        this.$.selector.selectItem(this.value);
      }

      if(this.$.selector.items) {
        this._focusedIndex = this.$.selector.items.indexOf(this.$.input.bindValue);
      }
    },

    _filter: function(arr, filter) {
      return arr.filter(function(item) {
        filter = filter || '';

        // Check if item contains input value.
        return item.toString().toLowerCase()
                .indexOf(filter.toString().toLowerCase()) > -1;
      }.bind(this));
    },

    _selectedItemChanged: function() {
      var _val = this.$.selector.selectedItem;
      if (_val !== null) {
        this.value = _val;
      }
    },

    _openedChanged: function() {
      if (this.opened) {
        this._setItems(this.items);
      } else {
        this.$.input.bindValue = this.value;
        this.$.fullScreenInput.bindValue = this.value;
      }
    },

    _isFiltering: function() {
      return this.$.input.bindValue !== '' && this.$.input.bindValue !== this.value;
    },

    _preventDefault: function(e) {
      e.preventDefault();
    },

    /**
     * Close the overlay.
     */
    close: function() {
      this.$.overlay.close();
    },

    /**
    * Validates the input element and sets an error style if needed.
    *
    * @return {boolean}
    */
    _getValidity: function(){
      return this.$.input.validate();
    }

  });
</script>
