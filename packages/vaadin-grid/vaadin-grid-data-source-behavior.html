<script>
  window.vaadin = window.vaadin || {};
  vaadin.elements = vaadin.elements || {};
  vaadin.elements.grid = vaadin.elements.grid || {};

  vaadin.elements.grid.DataSourceBehavior = {

    properties: {

      pageSize: {
        type: Number,
        value: 50
      },

      dataSource: Function,

      _cache: {
        value: function() {
          return {};
        }
      },

      _pendingRequests: {
        value: function() {
          return {};
        }
      }

    },

    _getItem: function(index, callback) {
      // this.async(function() {

        var page = this._getPageForIndex(index);

        if (this._cache[page]) {
          callback(this._cache[page][index - page * this.pageSize]);
          return true;
        }

        if (this._pendingRequests[page]) {
          this._pendingRequests[page].push({
            index: index,
            callback: callback
          });
        } else {
          this._pendingRequests[page] = [{
            index: index,
            callback: callback
          }];

          // this._loadPage(page);
          this.async(this._loadPage.bind(this, page), 100);
        }

      // });
    },


    _loadPage: function(page) {
      this.dataSource(page, this.pageSize, function(items) {
        this._cache[page] = items;

        this._pendingRequests[page].forEach(function(req) {
          req.callback(items[req.index - this.pageSize * page]);
        }, this);
        delete this._pendingRequests[page];
      }.bind(this));
    },

    _getPageForIndex: function(index) {
      return Math.floor(index / this.pageSize);
    }

  };
</script>
