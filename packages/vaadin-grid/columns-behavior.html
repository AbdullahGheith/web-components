<script>
  window.vaadin = window.vaadin || {};
  vaadin.elements = vaadin.elements || {};
  vaadin.elements.grid = vaadin.elements.grid || {};

  vaadin.elements.grid.GridColumnsBehaviorImpl = {
    properties: {
      columns: Array
    },

    observers: [
      '_columnsChanged(columns, _physicalCount)'
    ],

    _columnsChanged: function(columns) {
      this._physicalItems.forEach(function(row) {
        row.innerHTML = '';
        for (var colIndex = 0; colIndex < columns.length; colIndex++) {
          var cell = document.createElement('td', 'vaadin-grid-cell');
          cell.target = this.domHost;
          var column = columns[colIndex];
          cell.column = column;
          cell.template = column.template;
          cell.toggleClass('frozen', colIndex < this.frozenColumns);
          cell.toggleClass('last-frozen', colIndex === this.frozenColumns - 1);
          Polymer.dom(row).appendChild(cell);
        }
      }, this);

      this.$.header.innerHTML = '';
      var spanning = [];
      columns.forEach(function(column, columnIndex) {
        column.headers.forEach(function(header, headerIndex) {
          var headerRow = this.$.header.childNodes[headerIndex];
          if (!headerRow) {
            headerRow = document.createElement('tr');
            Polymer.dom(this.$.header).appendChild(headerRow);
          }
          var cell = document.createElement('th', 'vaadin-grid-header-cell');
          cell.target = this.domHost;
          cell.template = header.template;
          cell.column = column;
          cell.toggleClass('frozen', columnIndex < this.frozenColumns);
          var colspan = header.colspan || 1;
          cell.toggleClass('last-frozen', columnIndex + colspan - 1 === this.frozenColumns - 1);


          if (header.colspan > 1) {
            spanning[headerIndex] = header.colspan;

            var width = cell.style.flexBasis || '100px';
            var flex = cell.style.flexGrow || 1;
            for (var i = 1; i < spanning[headerIndex]; i++) {
              width += ' + ' + (columns[columnIndex + i].minWidth || columns[columnIndex + i].width || '100px');
              flex++;
            }

            cell.style.flexBasis = 'calc(' + width + ')';
            cell.style.flexGrow = flex;
          }


          if (!header.colspan && spanning[headerIndex] > 0) {
            cell.style.display = 'none';
          }

          spanning[headerIndex]--;

          Polymer.dom(headerRow).appendChild(cell);

        }, this);
      }, this);

      requestAnimationFrame(function() {
        this.$.items.style.paddingTop = this.$.header.clientHeight + 'px';
      }.bind(this));


    }
  };

  vaadin.elements.grid.GridColumnsBehavior = [
    vaadin.elements.grid.GridColumnsBehaviorImpl
  ];
</script>
