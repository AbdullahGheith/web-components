<dom-module id="vaadin-grid-header-cell">
  <template>
    <style>
      ::content> div {
        padding: 8px;
      }

      :host {
        flex-shrink: 0;
        flex-grow: 1;
        flex-basis: 100px;
        box-sizing: border-box;
        display: block;
        overflow: hidden;
      }
    </style>

    <content></content>
  </template>
  <script>
    Polymer({
      is: 'vaadin-grid-header-cell',

      extends: 'th',

      behaviors: [
        Polymer.Templatizer
      ],

      properties: {
        column: Object,
        colspan: {
          type: Number,
          value: 0,
          notify: true
        },
        headerIndex: Number,
        instance: Object,
        template: {
          observer: '_templateChanged'
        },

        target: Object
      },

      observers: ['_headerIndexChanged(headerIndex, _headers)', '_columnChanged(column)'],

      _columnChanged: function(column) {
        this._headers = column.headers;
        this.listen(column, 'headers-changed', '_headersChanged');
      },

      _headersChanged: function(e) {
        this._headers = e.detail.value;
      },

      _headerIndexChanged: function(headerIndex, headers) {
        if (headers[headerIndex]) {
          this.template = headers[headerIndex].template;
          this.colspan = headers[headerIndex].colspan;
        }
      },

      _templateChanged: function(template) {
        this.templatize(this.template);

        // fix _rootDataHost to the context where template has been defined
        if (template._rootDataHost) {
          this._getRootDataHost = function() { return template._rootDataHost; };
        }
        
        this.instance = this.stamp(null);

        var item = document.createElement('div');
        var itemClass = 'item-' + this.target.childElementCount;
        item.classList.add(itemClass);

        if (Polymer.Settings.useShadow) {

          Polymer.dom(this.target).appendChild(item);

          var content = document.createElement('content');
          content.setAttribute('select', '.' + itemClass);
          Polymer.dom(this).appendChild(content);

        } else {
          // Non-shadow
          Polymer.dom(this).appendChild(item);
        }
        Polymer.dom(item).appendChild(this.instance.root);
      }
    });
  </script>
</dom-module>
