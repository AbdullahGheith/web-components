<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="vaadin-grid-scroller.html">
<link rel="import" href="vaadin-grid-column.html">
<link rel="import" href="vaadin-grid-row-details-behavior.html">
<link rel="import" href="vaadin-grid-data-source-behavior.html">

<dom-module id="vaadin-grid">
  <style>
    :host {
      display: block;
    }

    #scroller {
      border: 1px solid;
      height: 100%;
      width: 100%;
    }
  </style>
  <template>
    <vaadin-grid-scroller bind-data="[[_bindData]]" size="[[size]]" id="scroller" columns="[[columns]]" frozen-columns=[[frozenColumns]] content-target=[[_getContentTarget()]] row-details-template=[[rowDetailsTemplate]]>
      <content></content>
    </vaadin-grid-scroller>
  </template>
</dom-module>

<script>
  Polymer({
    is: 'vaadin-grid',

    properties: {

      columns: Array,

      size: Number,

      frozenColumns: {
        value: 0
      },

      rowDetailsTemplate: Object,

      _bindData: {
        value: function() {
          return this._doBindData.bind(this);
        }
      }
    },

    behaviors: [
      vaadin.elements.grid.GridRowDetailsBehavior,
      vaadin.elements.grid.DataSourceBehavior
    ],

    _doBindData: function(index, row) {
      // TODO: No async
      this.async(function() {
        var callback = function(item) {
          if (row.index === index) {
            this._updateItem(row, item);
          }
        }.bind(this);

        if (!this._getItem(index, callback)) {
          // Item wasn't cached, clear the row item
          this._updateItem(row, null);
        }
      }, 1);
    },

    _updateItem: function(row, item) {
      // row.expanded = this._isExpanded(item);
      if (row._item === item) {
        return;
      }
      row._item = item;

      row.iterateCells(function(cell) {
        cell.instance.item = item;
      });
      this.debounce('update-scroller', function() {
        this.$.scroller._update();
      }, 1);
    },

    _getContentTarget: function() {
      return this;
    },

    _isFrozenColumn: function(column) {
      return this.columns.indexOf(column) < this.frozenColumns;
    },

    ready: function() {
      this.columns = Polymer.dom(this).querySelectorAll('vaadin-grid-column');
      this.rowDetailsTemplate = Polymer.dom(this).querySelector('template[is=row-details]');
    },



  });
</script>
