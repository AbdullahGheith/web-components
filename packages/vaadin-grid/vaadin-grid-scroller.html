<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-resizable-behavior/iron-resizable-behavior.html">
<link rel="import" href="../iron-a11y-keys-behavior/iron-a11y-keys-behavior.html">
<link rel="import" href="../iron-scroll-target-behavior/iron-scroll-target-behavior.html">
<link rel="import" href="scroll-behavior.html">
<link rel="import" href="vaadin-grid-sizer.html">
<link rel="import" href="vaadin-outer-scroller.html">
<link rel="import" href="vaadin-grid-header.html">
<link rel="import" href="vaadin-grid-edge-behavior.html">
<link rel="import" href="vaadin-grid-cell.html">
<link rel="import" href="vaadin-grid-row.html">
<link rel="import" href="iron-list-behavior.html">

<dom-module id="vaadin-grid-scroller">
  <link rel="import" type="css" href="../bootstrap/dist/css/bootstrap.css">
  <template>
    <style include="fixedmode-styles"></style>
    <style include="vaadin-grid-edge-styles"></style>
    <style>
      :host {
        display: block;
        position: relative;
      }

      @media only screen and (-webkit-max-device-pixel-ratio: 1) {
        :host {
          will-change: transform;
        }
      }

      #items {
        @apply(--iron-list-items-container);
        position: relative;
      }

      :host(:not([grid])) #items > ::content > * {
        width: 100%;
      };

      #items > tr {
        box-sizing: border-box;
        margin: 0;
        position: absolute;
        /* iron-list expects top to be 0. Might cause issues */
        /*top: 0;*/
        will-change: transform;
      }

      table {
        height: 100%;
        width: 100%;
        display: block;
        overflow: auto;
      }

      :host([ios]) table {
        /* On iOS we should be always scrolling the outer scroller. */
        overflow: hidden;
      }

      tbody {
        display: block;
      }

      thead th {
        top: 0;
        background-color: #fff;
      }

      td, th {
        background-color: #fff;

        /* Bootstrap adds 8px padding to each cell, IE flexbasis ignores border-box so need to revert */
        padding: 0 !important;
      }

      tr[odd] td {
        background-color: #f9f9f9;
      }

      tr:hover td {
        background-color: lightgrey;
      }

      tr:not([hidden]) {
        display: flex;
        width: 100%;
      }

      [frozen] {
        z-index: 1;
      }

      [last-frozen] {
        border-right: 2px solid #ddd;
      }

      caption {
        position: absolute;
        display: block;
        padding: 0;
        width: 100%;
        z-index: -100;
      }

    </style>

    <table id="table" class="table table-striped">
      <caption>
        <div is="vaadin-grid-sizer" scroll-height="[[_estScrollHeight]]" columns="[[columns]]">
        </div>
      </caption>
      <thead id="header" is="vaadin-grid-header" row-count="2" columns="[[columns]]" frozen-columns="[[frozenColumns]]"></thead>
      <tbody id="items"></tbody>
    </table>

    <vaadin-outer-scroller id="outerscroller" scroll-target="[[scrollTarget]]">
      <div is="vaadin-grid-sizer" scroll-height="[[_estScrollHeight]]" columns="[[columns]]"></div>
    </vaadin-outer-scroller>

  </template>
</dom-module>

<script>

  Polymer({

    is: 'vaadin-grid-scroller',

    behaviors: [
      vaadin.elements.grid.IronListBehavior
    ],

    properties: {
      size: Number,

      columns: Array,

      dataSource: {
        type: Function,
        value: function() {
          return function(index, callback) {
            callback(index, index > this.size - 1 ? null : {});
          };
        }
      }

    },

    observers: [
      '_columnsChanged(columns, frozenColumns, _physicalCount, _physicalItems)',
      '_sizeChanged(size)'
    ],

    // TODO: we should observe _physicalItems.splices instead of _physicalCount
    _columnsChanged: function(columns, frozenColumns) {
      this._physicalItems.forEach(function(row) {
        row.columns = columns;
        row.frozenColumns = frozenColumns;
      });

      requestAnimationFrame(function() {
        this.$.outerscroller.style.paddingTop = this.$.table.style.paddingTop = this.$.header.clientHeight + 'px';
      }.bind(this));
    },

    /**
     * Creates a pool of DOM elements and attaches them to the local dom.
     */
    _createPool: function(size) {
      var physicalItems = new Array(size);

      for (var i = 0; i < size; i++) {
        var row = document.createElement('tr', 'vaadin-grid-row');
        row.target = this.domHost;
        physicalItems[i] = row;
        row.setAttribute('hidden', ''); //hidden by default, removed when data is bound.
        Polymer.dom(this.$.items).appendChild(row);
      }

      return physicalItems;
    },

    _sizeChanged: function(size) {
      this._virtualStart = 0;
      this._physicalTop = 0;

      /* TODO: virtual count of 500k will make the sizer.top too large for Firefox */
      this._virtualCount = Math.min(size, 100000);
      this._physicalIndexForKey = {};
      this._firstVisibleIndexVal = null;
      this._lastVisibleIndexVal = null;

      this._vidxOffset = 0;
      this._resetScrollPosition(0);

      if (!this._physicalItems) {
        var DEFAULT_PHYSICAL_COUNT = 25;

        this._physicalCount = Math.max(1, Math.min(DEFAULT_PHYSICAL_COUNT, this._virtualCount));
        this._physicalItems = this._createPool(this._physicalCount);
        this._physicalSizes = new Array(this._physicalCount);
      }

      this._physicalStart = 0;

      this._itemsRendered = false;
      this._debounceTemplate(this._render);
    },

    /**
     * Assigns the data models to a given set of items.
     * @param {!Array<number>=} itemSet
     */
    _assignModels: function(itemSet) {
      this._iterateItems(function(pidx, vidx) {
        var el = this._physicalItems[pidx];
        el.index = vidx + this._vidxOffset;

        this.dataSource(vidx, function(index, item) {
          if (item !== null && el.index === index + this._vidxOffset) {
            el.item = item;
            this._physicalIndexForKey[el.index] = pidx;
            el.removeAttribute('hidden');
          } else {
            el.setAttribute('hidden', '');
          }
        }.bind(this));
      }, itemSet);
    }

  });

</script>
