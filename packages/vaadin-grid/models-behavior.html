<script>
  window.vaadin = window.vaadin || {};
  vaadin.elements = vaadin.elements || {};
  vaadin.elements.grid = vaadin.elements.grid || {};

  vaadin.elements.grid.GridModelsBehaviorImpl = {

    properties: {
      dataSource: {
        type: Function,
        value: function() {
          return function(index, callback) {
            callback(index, index > this.size - 1 ? null : {});
          };
        }
      },

      size: Number,
    },

    observers: ['_sizeChanged(size)'],

    _sizeChanged: function(size) {
      this._virtualStart = 0;
      this._physicalTop = 0;

      /* TODO: virtual count of 500k will make the sizer.top too large for Firefox */
      this._virtualCount = Math.min(size, 100000);
      this._physicalIndexForKey = {};
      this._firstVisibleIndexVal = null;
      this._lastVisibleIndexVal = null;

      this._vidxOffset = 0;
      this._resetScrollPosition(0);

      if (!this._physicalItems) {
        var DEFAULT_PHYSICAL_COUNT = 25;

        this._physicalCount = Math.max(1, Math.min(DEFAULT_PHYSICAL_COUNT, this._virtualCount));
        this._physicalItems = this._createPool(this._physicalCount);
        this._physicalSizes = new Array(this._physicalCount);
      }

      this._physicalStart = 0;

      this._itemsRendered = false;
      this._debounceTemplate(this._render);
    },

    /**
     * Assigns the data models to a given set of items.
     * @param {!Array<number>=} itemSet
     */
    _assignModels: function(itemSet) {
      this._iterateItems(function(pidx, vidx) {
        var el = this._physicalItems[pidx];
        el.index = vidx + this._vidxOffset;

        this.dataSource(vidx, function(index, item) {
          if (item != null && el.index === index + this._vidxOffset) {
            el.item = item;
            // inst.tabIndex = this._focusedIndex === vidx ? 0 : -1;
            // this._physicalIndexForKey[inst.__key__] = pidx;
            el.removeAttribute('hidden');
          } else {
            inst.__key__ = null;
            el.setAttribute('hidden', '');
          }
        }.bind(this));
      }, itemSet);
    },
  };

  vaadin.elements.grid.GridModelsBehavior = [
    vaadin.elements.grid.GridModelsBehaviorImpl
  ];
</script>
