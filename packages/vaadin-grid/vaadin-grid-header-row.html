<link rel="import" href="vaadin-grid-header-cell.html">

<dom-module id="vaadin-grid-header-row">
  <script>
    Polymer({
      is: 'vaadin-grid-header-row',
      extends: 'tr',

      properties: {
        columns: Array,
        index: Number,
        headerIndex: Object,
        cells: Array,
        frozenColumns: Number,
        target: Object
      },

      observers: ['_columnsChanged(columns, headerIndex, target)', '_indexChanged(index, cells)', '_frozenColumnsChanged(frozenColumns, cells)'],

      _colspanChanged: function() {
        var spanning = 0;
        this.cells.forEach(function(cell, index) {

          // TODO: reset cell styles to make sure colspan have be changed dynamically.
          cell.style.display = '';
          cell.style.flexBasis = this.columns[index].minWidth || this.columns[index].width || '100px';
          cell.style.flexGrow = 1;

          if (cell.colspan > 1) {
            spanning = cell.colspan;

            var width = cell.style.flexBasis || '100px';
            var flex = cell.style.flexGrow || 1;
            for (var i = 1; i < spanning; i++) {
              width += ' + ' + (this.columns[index + i].minWidth || this.columns[index + i].width || '100px');
              flex++;
            }

            cell.style.flexBasis = 'calc(' + width + ')';
            cell.style.flexGrow = flex;
          }

          if (!cell.colspan && spanning > 0) {
            cell.style.display = 'none';
          }

          spanning = Math.max(0, spanning - 1);
        }.bind(this));
      },

      //TODO: implement support for columns.splices
      _columnsChanged: function(columns, headerIndex, target) {
        var cells = [];
        var spanning = 0;

        columns.forEach(function(column, columnIndex) {
          var cell = document.createElement('th', 'vaadin-grid-header-cell');
          cell.index = this.index;
          cell.target = this.target;
          cell.column = column;
          cell.headerIndex = headerIndex;

          this.listen(cell, 'colspan-changed', '_colspanChanged');

          Polymer.dom(this).appendChild(cell);
          cells.push(cell);

        }.bind(this));

        this.cells = cells;
        this._colspanChanged();
      },

      _frozenColumnsChanged: function(frozenColumns, cells) {
        cells.forEach(function(cell, i) {
          cell.toggleAttribute('frozen', i < frozenColumns);
          cell.toggleAttribute('last-frozen', i === frozenColumns - 1);
        });
      },

      _indexChanged: function(index, cells) {
        cells.forEach(function(cell) {
          cell.index = index;
        });
      }
    });
  </script>
</dom-module>
